===============================================
   PHASE 2: PAYMENT RECONCILIATION TESTS
===============================================

Testing Database Structure...
  Γ£ô payments.reconciliation_status column exists
  Γ£ô payments.mpesa_receipt_number column exists
  Γ£ô payments.transaction_date column exists
  Γ£ô payments.sender_phone column exists
  Γ£ô payments.sender_name column exists
  Γ£ô payments.paybill_account column exists
  Γ£ô payments.reconciled_at column exists
  Γ£ô payments.reconciled_by column exists
  Γ£ô payments.reconciliation_notes column exists
  Γ£ô payments.auto_matched column exists
  Γ£ô mpesa_c2b_callbacks table exists
  Γ£ô payment_reconciliation_log table exists
  Γ£ô vw_unmatched_payments view exists
  Γ£ô vw_pending_reconciliation view exists

Testing Service Class...
  Γ£ô PaymentReconciliationService class exists
  Γ£ô PaymentReconciliationService can be instantiated

Testing Service Methods...
  Γ£ô Method processC2BCallback exists
  Γ£ô Method autoReconcilePayment exists
  Γ£ô Method manualReconciliation exists
  Γ£ô Method getUnmatchedPayments exists
  Γ£ô Method findPotentialMatches exists
  Γ£ô Method getReconciliationStats exists

Testing Auto-Reconciliation by ID Number...
PHP Warning:  Undefined array key "first_name" in C:\xampp\htdocs\Shena\app\services\PaymentReconciliationService.php on line 176
  Γ£ô Auto-reconciliation executed
  Γ£ô Payment matched by ID number
  Γ£ô Matched correct member
  Γ£ô Match method is auto_id_number
  Γ£ô High confidence match
PHP Warning:  Undefined array key "last_name" in C:\xampp\htdocs\Shena\app\services\PaymentReconciliationService.php on line 176

Testing Auto-Reconciliation by Phone...
PHP Warning:  Undefined array key "first_name" in C:\xampp\htdocs\Shena\app\services\PaymentReconciliationService.php on line 176
  Γ£ô Auto-reconciliation executed
PHP Warning:  Undefined array key "last_name" in C:\xampp\htdocs\Shena\app\services\PaymentReconciliationService.php on line 176
  Γ£ô Payment matched by phone
  Γ£ô Matched correct member
  Γ£ô Match method is auto_phone

Testing Unmatched Payment Creation...
  Γ£ô Unmatched payment processing succeeded
  Γ£ô Payment marked as unmatched
  Γ£ô Payment ID returned
  Γ£ô Payment record created
  Γ£ô Status is unmatched
  Γ£ô No member linked

Testing Manual Reconciliation...
  Γ£ô Manual reconciliation succeeded
  Γ£ô Member linked
  Γ£ô Status is manual
  Γ£ô Reconciled timestamp set
  Γ£ô Reconciled by user recorded
  Γ£ô Reconciliation log entry created
  Γ£ô Log action is manual_match

Testing Potential Matches Finding...
PHP Warning:  Undefined array key "first_name" in C:\xampp\htdocs\Shena\test_phase2_reconciliation.php on line 368
PHP Warning:  Undefined array key "last_name" in C:\xampp\htdocs\Shena\test_phase2_reconciliation.php on line 368
PHP Warning:  Undefined array key "first_name" in C:\xampp\htdocs\Shena\app\services\PaymentReconciliationService.php on line 176
PHP Warning:  Undefined array key "last_name" in C:\xampp\htdocs\Shena\app\services\PaymentReconciliationService.php on line 176
Database query error: SQLSTATE[42S22]: Column not found: 1054 Unknown column 'first_name' in 'where clause'
  Γ£ù Potential matches finding: Database query failed: SQLSTATE[42S22]: Column not found: 1054 Unknown column 'first_name' in 'where clause'

Testing C2B Callback Processing...
SQL: SELECT *, 'name' as match_type, 60 as confidence 
                          FROM members 
                          WHERE (first_name LIKE :first OR last_name LIKE :last)
                          LIMIT 5
Params: Array
(
    [first] => %%
    [last] => %%
)

PHP Warning:  Undefined array key "first_name" in C:\xampp\htdocs\Shena\app\services\PaymentReconciliationService.php on line 176
PHP Warning:  Undefined array key "last_name" in C:\xampp\htdocs\Shena\app\services\PaymentReconciliationService.php on line 176
  Γ£ô C2B callback processed successfully
  Γ£ô Callback payment matched
  Γ£ô Callback stored in database
  Γ£ô Callback marked as processed

Testing Duplicate Callback Handling...
  Γ£ô First callback processed
  Γ£ô Duplicate callback rejected
  Γ£ô Duplicate flag set

Testing Reconciliation Statistics...
  Γ£ô Stats returned as array
  Γ£ô total_payments stat exists
  Γ£ô matched stat exists
  Γ£ô unmatched stat exists
  Γ£ô manual stat exists
  Γ£ô auto_matched stat exists
  Γ£ô total_amount stat exists

Testing Phone Number Formatting...
  Γ£ô Phone format: 0712345678 -> +254712345678
  Γ£ô Phone format: 254712345678 -> +254712345678
  Γ£ô Phone format: 712345678 -> +254712345678

Testing Transaction Time Parser...
  Γ£ô TransTime parsed correctly


===============================================
   TEST SUMMARY
===============================================
Passed: 62
Failed: 1
Total:  63
===============================================
